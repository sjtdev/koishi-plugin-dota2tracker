<%# --- 基础数据与工具函数 --- %>
<% const p = data; %>
<% const isAnon = p.steamAccount.isAnonymous; %>

<%# --- 工具: 颜色计算 --- %>
<% const getWinRateColor = (val) => {
     val = Math.max(0, Math.min(100, val * 100));
     let r, g, b;
     if (val <= 50) {
       const s = Math.round(255 * (val / 50));
       r = 255; g = s; b = s;
     } else {
       const s = Math.round(255 * ((val - 50) / 50));
       r = 255 - s; g = 255; b = 255 - s;
     }
     const hex = c => c.toString(16).padStart(2, "0").toUpperCase();
     return `#${hex(r)}${hex(g)}${hex(b)}`;
   };
%>

<%# --- 工具: 公会等级 --- %>
<% const getGuildClass = pct => pct <= 25 ? "Copper" : pct <= 50 ? "Silver" : pct <= 75 ? "Gold" : "Diamond"; %>

<%# --- 核心逻辑: 比赛数据预处理 (Streak, Lane, NearWin) --- %>
<% const outcomes = { victory: 0, stomp: 0, fail: 0, stomped: 0, tie: 0 }; %>
<% const laneMap = { RADIANT_VICTORY:['victory','fail'], RADIANT_STOMP:['stomp','stomped'], DIRE_VICTORY:['fail','victory'], DIRE_STOMP:['stomped','stomp'] }; %>
<% let nearWin = 0, streak = 0; %>
<% const nearCount = 25; %>

<%# --- 遍历比赛，计算连胜与分路 --- %>
<% const matchesData = p.matches.map(m => {
     const inner = m.players.find(ip => p.steamAccount.id == ip.steamAccount.id);
     const isRad = inner.isRadiant;
     const didWin = m.didRadiantWin === isRad;

     // 连胜计算
     if (!p.streak) {
       if (streak !== 0) {
         if (didWin && streak > 0) streak++;
         else if (!didWin && streak < 0) streak--;
         else p.streak = streak;
       } else streak = didWin ? 1 : -1;
     }

     // 近期胜率
     nearWin += didWin ? 1 : 0;

     // 分路结果处理
     const resRaw = laneMap[m.topLaneOutcome] || ['tie','tie'];
     // 这里简化分路判定逻辑，只关注 outcome 计数，具体每局的 laneResult 下面处理
     let laneRes = "tie";
     if (inner.lane === "JUNGLE") laneRes = "jungle";
     else {
       const laneKey = inner.lane === "MID_LANE" ? "mid" : (inner.lane === "SAFE_LANE" ? (isRad?"bottom":"top") : (isRad?"top":"bottom"));
       // 注意：原逻辑 processLaneOutcome 对三路都做了处理，这里为了性能只取玩家所在路
       const outcomeKey = laneKey === 'mid' ? m.midLaneOutcome : (laneKey === 'top' ? m.topLaneOutcome : m.bottomLaneOutcome);
       const pair = laneMap[outcomeKey] || ['tie', 'tie'];
       laneRes = pair[isRad ? 0 : 1];
     }
     if (outcomes[laneRes] !== undefined) outcomes[laneRes]++;

     // 击杀参与率 KDA
     const teamKills = m.parsedDateTime
       ? (m[(isRad ? "radiant" : "dire") + "Kills"]?.reduce((a, b) => a + b, 0) ?? 0)
       : m.players.filter(pl => pl.isRadiant === isRad).reduce((a, pl) => a + pl.kills, 0);
     const kp = ((inner.kills + inner.assists) / (teamKills || 1) * 100).toFixed(0);
     const kda = ((inner.kills + inner.assists) / Math.max(1, inner.deaths)).toFixed(2);

     return {
       ...m,
       inner,
       laneRes,
       didWin,
       kda,
       kp,
       timeStr: DateTime.fromSeconds(m.startDateTime ?? 0).toFormat("yyyy-MM-dd HH:mm:ss").slice(2)
     };
   });
%>

<%# --- 英雄列表与位置数据预计算 --- %>
<%# 计算进度条比例因子 %>
<% const getScale = (list, isNear) => {
     if (!list || list.length === 0) return 0;
     const maxWin = Math.max(...list.map(i => i.winCount));
     const maxLose = Math.max(...list.map(i => i.matchCount - i.winCount));
     // 800 - (5 * 40) = 600px available
     const totalW = 600;
     const baseScale = totalW / (maxWin + maxLose || 1);
     // 近期数据需要调整因子
     return isNear ? baseScale * Math.min(maxWin/(maxWin+maxLose), maxLose/(maxWin+maxLose)) : baseScale;
   };
%>
<% const heroList = p.genHero ? p.heroesPerformanceTop10 : (p.heroesPerformance?.filter(h => h.matchCount > 1) || []); %>
<% const heroScale = getScale(heroList, !p.genHero); %>

<%# 位置数据处理 %>
<% const posIcons = ["damage","nuke","armor","speed","healing"]; %>
<% p.positionPerformance = []; %>
<% for (let i = 0; i < 5; i++) {
     const posMatches = p.matches.filter(m => m.players.find(ip => ip.steamAccount.id == p.steamAccount.id).position == ("POSITION_" + (i + 1)));
     const wins = posMatches.filter(m => m.didRadiantWin == m.players.find(ip => ip.steamAccount.id == p.steamAccount.id).isRadiant).length;
     const impAvg = posMatches.length > 0 ? Math.round(posMatches.reduce((acc, m) => acc + m.players.find(ip => ip.steamAccount.id == p.steamAccount.id).imp, 0) / posMatches.length) : "-";
     p.positionPerformance.push({ pos: i + 1, icon: posIcons[i], matchCount: posMatches.length, winCount: wins, imp: impAvg });
   }
%>
<% const posScale = getScale(p.positionPerformance.filter(pos => pos.matchCount > 1), true); %>


<!DOCTYPE html>
<html lang="<%= languageTag %>">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Player</title>

    <%- `<style>` %>
      <%- include("../common/styles/normalize.min.css") %>
      <%- include(`./player_1/base.css`) %>
    <%- `</style>` %>
</head>
<body>
    <div class="wrapper">
        <%# --- 玩家头部信息 --- %>
        <div class="player">
            <div class="avatar"><img src="<%= p.steamAccount?.avatar %>" alt="" /></div>
            <div class="info">
                <p class="name">
                    <%= p.steamAccount.name %>
                    <% if (p.guildMember) { %>
                    <span class="guild <%= getGuildClass(p.guildMember.guild.currentPercentile) %>"><%= p.guildMember.guild.tag %></span>
                    <% } %>
                    <% if (p.genHero) { %>
                    <span class="hero_name"><%= p.genHero.name %></span>
                    <% } %>
                </p>
                <p class="matches">
                    <%= $t("dota2tracker.template.match_count_") %><%= p.matchCount %>
                    (<span class="win"><%= p.winCount %></span>/<span class="lose"><%= p.matchCount - p.winCount %></span>) &nbsp;&nbsp;
                    <%= $t("dota2tracker.template.winrate_") %>
                    <span <%- `style="color:${getWinRateColor(p.winCount / p.matchCount)};"` %>><%= ((p.winCount / p.matchCount) * 100).toFixed(2) %>%</span>
                </p>
                <p class="matches<%= isAnon ? " blur" : "" %>">
                    <span><%= $t("dota2tracker.template.last25matches_") %>
                        <span class="win"><%= nearWin %></span>/<span class="lose"><%= nearCount - nearWin %></span>
                    </span>&nbsp;
                    <span><%= $t("dota2tracker.template.winrate_") %>
                        <span <%- `style="color:${getWinRateColor(nearWin / nearCount)};"` %>><%= ((nearWin / nearCount) * 100).toFixed(2) %>%</span>
                    </span>&nbsp;
                    <span><%= $t("dota2tracker.template.imp_") %><%= isAnon ? "?" : ((p.performance?.imp > 0 ? "+" : "") + p.performance?.imp) %></span>
                </p>
                <p class="matches<%= isAnon ? " blur" : "" %>">
                    <span><%= $t("dota2tracker.template.lane") %>
                        <span class="victory"><%= outcomes.victory + outcomes.stomp %>(<span class="stomp"><%= outcomes.stomp %></span>)</span>-<span class="tie"><%= outcomes.tie %></span>-<span class="fail"><%= outcomes.fail + outcomes.stomped %>(<span class="stomped"><%= outcomes.stomped %></span>)</span>
                    </span>&nbsp;&nbsp;
                    <% const laneTotal = outcomes.victory + outcomes.stomp + outcomes.tie + outcomes.fail + outcomes.stomped; %>
                    <% const laneScore = (outcomes.victory + outcomes.stomp + outcomes.tie / 2) / laneTotal; %>
                    <span><%= $t("dota2tracker.template.lane_advantage_rate_") %>
                        <span <%- `style="color:${getWinRateColor(laneScore)};"` %>><%= isAnon ? "?" : (laneScore * 100).toFixed(2) %>%</span>
                    </span>
                </p>
            </div>
            <div class="rank<%= p.isEstimatedRank ? " estimated" : "" %>">
                <img class="medal" src="<%= getImageUrl('medal_' + (p.rank.inTop100 ?? p.rank.medal)) %>" alt="" />
                <img class="star" src="<%= getImageUrl('star_' + p.rank.star) %>" alt="" />
                <p><%= p.steamAccount.seasonLeaderboardRank ?? "" %></p>
            </div>
        </div>

        <%# --- 英雄与位置表现 --- %>
        <div class="hero_winrate">
            <div class="heroes">
                <p class="tip row total"><%= p.genHero ? $t("dota2tracker.template.all_matches_") : $t("dota2tracker.template.top10_") %></p>
                <span class="tip"><%= $t("dota2tracker.template.hero") %></span>
                <span class="tip" style="margin: 0 4px"><%= $t("dota2tracker.template.match_count") %></span>
                <span class="tip" style="margin: 0 4px"><%= $t("dota2tracker.template.winrate") %></span>
                <span class="tip" style="margin: 0 4px"><%= $t("dota2tracker.template.imp") %></span>
                <span class="tip win_count" style="justify-self: end; margin-right: 2px"><%= $t("dota2tracker.template.win_count") %></span>
                <span class="tip lose_count" style="justify-self: start; margin-left: 2px"><%= $t("dota2tracker.template.lose_count") %></span>

                <%# 英雄列表循环 %>
                <% heroList.forEach(hero => { %>
                <span><img alt="" src="<%= getImageUrl(hero.hero.shortName, ImageType.HeroIcons) %>" /></span>
                <span class="count"><%= hero.matchCount %></span>
                <span class="win_rate"><%= ((hero.winCount / hero.matchCount) * 100).toFixed(0) %>%</span>
                <span class="imp"><%= (hero.imp > 0 ? "+" : "") + hero.imp %></span>
                <span class="win" <%- `style="${hero.winCount == 0 ? "visibility:hidden;" : ""}width: ${hero.winCount * heroScale}px"` %>><%= hero.winCount %></span>
                <span class="lose" <%- `style="${hero.matchCount - hero.winCount == 0 ? "visibility:hidden;" : ""}width: ${(hero.matchCount - hero.winCount) * heroScale}px"` %>><%= hero.matchCount - hero.winCount %></span>
                <% }); %>

                <p class="tip row near"><%= $t("dota2tracker.template.recently_positions") %></p>
                <span class="tip"><%= $t("dota2tracker.template.position") %></span>
                <span class="tip" style="margin: 0 4px"><%= $t("dota2tracker.template.match_count") %></span>
                <span class="tip" style="margin: 0 4px"><%= $t("dota2tracker.template.winrate") %></span>
                <span class="tip" style="margin: 0 4px"><%= $t("dota2tracker.template.imp") %></span>
                <span class="tip win_count" style="justify-self: end; margin-right: 2px"><%= $t("dota2tracker.template.win_count") %></span>
                <span class="tip lose_count" style="justify-self: start; margin-left: 2px"><%= $t("dota2tracker.template.lose_count") %></span>

                <%# 位置列表循环 %>
                <% p.positionPerformance.forEach(pos => { %>
                <span><img src="<%= getImageUrl(pos.icon, ImageType.IconsFacets) %>"></span>
                <span class="count"><%= pos.matchCount %></span>
                <span class="win_rate"><%= pos.matchCount > 0 ? ((pos.winCount / pos.matchCount) * 100).toFixed(0) : "-" %>%</span>
                <span class="imp"><%= (pos.imp > 0 ? "+" : "") + pos.imp %></span>
                <span class="win" <%- `style="${pos.winCount == 0 ? "visibility:hidden;" : ""}width: ${pos.winCount * posScale}px"` %>><%= pos.winCount %></span>
                <span class="lose" <%- `style="${pos.matchCount - pos.winCount == 0 ? "visibility:hidden;" : ""}width: ${(pos.matchCount - pos.winCount) * posScale}px"` %>><%= pos.matchCount - pos.winCount %></span>
                <% }); %>
            </div>

            <% if (isAnon) { %>
            <%- include("player_1/private", {$t, player: p}) %>
            <% } %>
        </div>

        <%# --- 连胜/连败提示 --- %>
        <% if (Math.abs(p.streak) > 1 && !isAnon) { %>
        <div class="streak" <%- `style="box-shadow:none;color:${getWinRateColor((p.streak + 10) / 20)};"` %>>
            <%= Math.abs(p.streak) + (p.streak > 0 ? $t("dota2tracker.template.winning_streak") : $t("dota2tracker.template.losing_streak")) %>
        </div>
        <% } %>

        <%# --- 比赛记录列表 --- %>
        <div>
            <table class="matches">
                <colgroup>
                    <col style="width: auto" /><col style="width: auto" /><col style="width: 40px" />
                    <col style="width: auto" /><col style="width: 40px" /><col style="width: auto" />
                    <col style="width: auto" /><col style="width: auto" /><col style="width: 40px" />
                </colgroup>
                <thead>
                    <tr>
                        <th><%= $t("dota2tracker.template.id") %></th>
                        <th><%= $t("dota2tracker.template.mode") %></th>
                        <th><%= $t("dota2tracker.template.hero") %></th>
                        <th><%= $t("dota2tracker.template.kda_kc") %></th>
                        <th><%= $t("dota2tracker.template.lane") %></th>
                        <th><%= $t("dota2tracker.template.time") %></th>
                        <th><%= $t("dota2tracker.template.duration") %></th>
                        <th><%= $t("dota2tracker.template.imp") %></th>
                        <th><%= $t("dota2tracker.template.rank") %></th>
                    </tr>
                </thead>
                <tbody>
                    <% matchesData.forEach(m => { %>
                    <tr class="match <%= m.didWin ? "win" : "lose" %>">
                        <td><%- m.parsedDateTime ? m.id : `<p>${m.id}</p><p>${$t("dota2tracker.template.un_parsed")}</p>` %></td>
                        <td>
                            <p><%= $t("dota2tracker.template.lobby_types." + m.lobbyType) || m.lobbyType %></p>
                            <p><%= $t("dota2tracker.template.game_modes." + m.gameMode) || m.gameMode %></p>
                        </td>
                        <td><img alt="" src="<%= getImageUrl(m.inner.hero.shortName, ImageType.HeroIcons) %>" /></td>
                        <td style="line-height: 20px">
                            <p><%= m.kda %> (<%= (m.parsedDateTime ? "" : "≈") + m.kp %>%)</p>
                            <p><%= m.inner.kills %>/<%= m.inner.deaths %>/<%= m.inner.assists %></p>
                        </td>
                        <td><div class="player_lane <%= m.laneRes %>"><%- getImageUrl("lane_" + m.laneRes, undefined, ImageFormat.svg) %></div></td>
                        <td style="line-height: 20px"><%= m.timeStr %></td>
                        <td><%= m.durationTime %></td>
                        <td><%= m.inner.imp != null ? ((m.inner.imp >= 0 ? "+" : "") + m.inner.imp) : "?" %></td>
                        <td><img class="medal" src="<%= getImageUrl("medal_" + m.rank?.toString().split("")[0]) %>" style="width: 100%" /></td>
                    </tr>
                    <% }); %>
                </tbody>
            </table>

            <% if (isAnon) { %>
            <%- include("player_1/private", {$t, player: p}) %>
            <% } %>
        </div>

        <%# --- Dota Plus 英雄 --- %>
        <div class="plus">
            <% p.dotaPlus.forEach(hero => { %>
            <div class="hero">
                <img src="<%= getImageUrl(hero.shortName, ImageType.Heroes) %>" alt="" />
                <div class="level"><img src="<%= getImageUrl("hero_badge_" + Math.ceil((hero.level + 1) / 6)) %>" alt="" /><span><%= hero.level %></span></div>
                <span><%= ((hero.winCount / hero.matchCount) * 100).toFixed(2) %>%</span>
                <span><%= hero.matchCount %></span>
            </div>
            <% }); %>

            <% if (isAnon) { %>
            <%- include("player_1/private", {$t, player: p}) %>
            <% } %>
        </div>
    </div>
</body>
</html>
