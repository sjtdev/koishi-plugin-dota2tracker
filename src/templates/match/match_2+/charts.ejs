<%# --- 基础配置 --- %>
<% const match = data; %>
<% const svgWidth = 400; %>
<% const svgHeight = 225; %>
<% const padding = 50; %>
<% const chartH = svgHeight - padding * 2; %>
<% const chartW = svgWidth - padding * 2; %>

<%# --- 数据准备 --- %>
<% const mainData = match.radiantNetworthLeads ?? []; %>
<% const secData = match.radiantExperienceLeads ?? []; %>
<% const maxVal = Math.max(...mainData.map(Math.abs), ...secData.map(Math.abs)); %>
<% const duration = match.durationSeconds; %>

<%# --- 比例尺计算 --- %>
<% const xScale = chartW / (duration - 1); %>
<% const yScale = chartH / (maxVal * 2); %>
<% const formatNum = n => Math.floor(n).toLocaleString(); %>

<%# --- 坐标计算工具 --- %>
<% const getX = i => padding + (i * 60 > duration ? ((((i - 1) * 60) + (duration % 60)) * xScale) : (i * xScale * 60)); %>
<% const getY = (val, scale) => svgHeight / 2 - val * scale; %>

<%# --- 点位生成: 次要数据 (经验) --- %>
<% const secPoints = secData.map((v, i) => `${getX(i)},${getY(v, yScale)}`).join(' '); %>
<% const secPoly = `${secPoints} ${svgWidth - padding},${svgHeight / 2} ${padding},${svgHeight / 2}`; %>

<%# --- 点位生成: 主要数据 (经济) & 区域填充 --- %>
<% const mainPointsRaw = mainData.map((v, i) => ({ val: v, x: getX(i), y: getY(v, yScale) })); %>
<% const mainPolyPoints = mainPointsRaw.map(p => `${p.x},${p.y}`).join(' '); %>

<%# --- 正负区域多边形计算 --- %>
<% let upperPts = [], lowerPts = []; %>
<% for (let i = 0; i < mainPointsRaw.length; i++) { %>
  <% const curr = mainPointsRaw[i], next = mainPointsRaw[i + 1]; %>
  <% if (curr.val >= 0) upperPts.push(`${curr.x},${curr.y}`); else lowerPts.push(`${curr.x},${curr.y}`); %>
  <% if (next && ((curr.val >= 0 && next.val < 0) || (curr.val < 0 && next.val >= 0))) { %>
    <% const t = Math.abs(curr.val) / (Math.abs(curr.val) + Math.abs(next.val)); %>
    <% const crossX = curr.x + t * (next.x - curr.x); %>
    <% const crossY = svgHeight / 2; %>
    <% upperPts.push(`${crossX},${crossY}`); lowerPts.push(`${crossX},${crossY}`); %>
  <% } %>
<% } %>
<% upperPts.push(`${svgWidth - padding},${svgHeight / 2}`, `${padding},${svgHeight / 2}`); %>
<% lowerPts.push(`${svgWidth - padding},${svgHeight / 2}`, `${padding},${svgHeight / 2}`); %>

<%# --- 胜率折线 --- %>
<% const wrPoints = match.winRates ? [match.winRates[0]].concat(match.winRates).map((v, i) => `${getX(i)},${svgHeight - padding - v * chartH}`).join(' ') : ''; %>

<%# --- 轴标签数据 (保留线，仅标记隐藏文字) --- %>
<% const timeLabels = []; %>
<% for (let i = 0; i < mainData.length - 1; i += 10) { %>
  <%# 如果当前刻度距离结束时间小于5分钟，则标记不显示文字，但保留数据用于画线 %>
  <% timeLabels.push({ x: getX(i), text: `${i.toString().padStart(2, '0')}:00`, showText: ((duration / 60) - i) >= 5 }); %>
<% } %>

<% const valLabels = [maxVal, maxVal / 2, 0, -maxVal / 2, -maxVal]; %>

<%# --- 玩家经济折线 (Player Networth) --- %>
<% const pNwData = match.players.map(p => p.stats.networthPerMinute.concat(p.networth)); %>
<% const maxNw = Math.max(...pNwData.flat().map(Math.abs)); %>
<% const nwYScale = chartH / maxNw; %>
<% const nwLabels = [maxNw, maxNw * 0.75, maxNw * 0.5, maxNw * 0.25, 0]; %>
<% const pColors = dotaconstants.player_colors; %>


<div id="charts">
  <%# --- 图表 1: 局势图 (经济差/经验差/胜率) --- %>
  <svg width="<%= svgWidth %>" height="<%= svgHeight %>" xmlns="http://www.w3.org/2000/svg">
    <text x="50%" y="30" text-anchor="middle" font-size="16" font-weight="bold"><%= $t("dota2tracker.template.situation") %></text>
    <image x="<%= padding %>" y="<%= padding %>" width="20" height="20" href="<%= getImageUrl("logo_radiant") %>"/>
    <image x="<%= padding %>" y="<%= svgHeight - padding * 1.4 %>" width="20" height="20" href="<%= getImageUrl("logo_dire") %>"/>
    <text x="<%= padding + 20 %>" y="<%= padding + 10 %>" dominant-baseline="middle" fill="#3c9028"><%= $t("dota2tracker.template.radiant") %></text>
    <text x="<%= padding + 20 %>" y="<%= svgHeight - padding * 1.4 + 10 %>" dominant-baseline="middle" fill="#9c3628"><%= $t("dota2tracker.template.dire") %></text>

    <%# 横轴线与数值标签 %>
    <% for (let i = 0; i < 5; i++) { %>
      <% const y = padding + i * (chartH / 4); %>
      <line x1="<%= padding %>" y1="<%= y %>" x2="<%= svgWidth - padding %>" y2="<%= y %>" stroke="gray" stroke-width="1" />
      <text x="<%= padding - 2 %>" y="<%= y %>" text-anchor="end" dominant-baseline="middle" fill="#333a"><%= formatNum(valLabels[i]) %></text>
    <% } %>

    <%# 纵轴线与时间标签 %>
    <% timeLabels.forEach(lbl => { %>
      <%# 始终绘制网格线 %>
      <line x1="<%= lbl.x %>" y1="<%= padding %>" x2="<%= lbl.x %>" y2="<%= svgHeight - padding %>" stroke="lightgray" stroke-width="1" />
      <%# 仅在不重叠时绘制文字 %>
      <% if (lbl.showText) { %>
      <text x="<%= lbl.x %>" y="<%= svgHeight - padding + 15 %>" text-anchor="middle" fill="#333a"><%= lbl.text %></text>
      <% } %>
    <% }); %>

    <%# 结束时间轴 %>
    <line x1="<%= svgWidth - padding %>" y1="<%= padding %>" x2="<%= svgWidth - padding %>" y2="<%= svgHeight - padding %>" stroke="lightgray" stroke-width="1" />
    <text x="<%= svgWidth - padding %>" y="<%= svgHeight - padding + 15 %>" text-anchor="middle" fill="#333a"><%= `${Math.floor(duration / 60)}:${(duration % 60).toString().padStart(2, '0')}` %></text>

    <%# 胜率折线 %>
    <% if (wrPoints) { %>
      <polyline points="<%= wrPoints %>" fill="none" stroke="lightgreen" stroke-width="3" />
    <% } %>

    <%# 经验差 (灰色) %>
    <polyline points="<%= secPoints %>" fill="none" stroke="gray" stroke-width="1" />
    <polygon points="<%= secPoly %>" fill="rgba(128, 128, 128, 0.3)" />

    <%# 经济差 (红绿填充) %>
    <polyline points="<%= mainPolyPoints %>" fill="none" stroke="rgba(100, 100, 100, 0.3)" stroke-width="2" />
    <polygon points="<%= upperPts.join(' ') %>" fill="rgba(0, 255, 0, 0.3)" />
    <polygon points="<%= lowerPts.join(' ') %>" fill="rgba(255, 0, 0, 0.3)" />

    <%# 图例 %>
    <g transform="translate(<%= padding %>, <%= svgHeight - 20 %>)">
      <%# 财产 %>
      <g transform="translate(0, 0)">
        <path d="M0,5 Q5,0 10,5 Z" fill="rgba(0, 255, 0, 0.5)"/>
        <path d="M10,5 Q15,10 20,5 Z" fill="rgba(255, 0, 0, 0.5)"/>
        <path d="M0,5 Q5,0 10,5 T20,5" fill="none" stroke="rgba(100, 100, 100, 0.3)" stroke-width="1"/>
        <text x="30" y="7" font-size="12" <%- match.odParsed ? 'fill="#ccc"' : '' %>>
          <%= match.odParsed ? $t("dota2tracker.template.opendota.gold_t") : $t("dota2tracker.template.networth") %>
        </text>
      </g>
      <%# 经验 %>
      <g transform="translate(120, 0)">
        <path d="M0,5 Q5,0 10,5 T20,5" fill="none" stroke="gray" stroke-width="1"/>
        <text x="30" y="7" font-size="12"><%= $t("dota2tracker.template.experience") %></text>
      </g>
      <%# 胜率 %>
      <g transform="translate(220, 0)">
        <path d="M0,5 Q5,0 10,5 T20,5" fill="none" stroke="lightgreen" stroke-width="3"/>
        <text x="30" y="7" font-size="12"><%= $t("dota2tracker.template.winrate") %></text>
      </g>
    </g>
  </svg>

  <%# --- 图表 2: 玩家个人经济走势 --- %>
  <svg width="<%= svgWidth %>" height="<%= svgHeight %>" xmlns="http://www.w3.org/2000/svg">
    <% if (match.odParsed) { %>
      <text x="50%" y="30" text-anchor="middle" font-size="16" font-weight="bold" fill="#ccc"><%= $t("dota2tracker.template.opendota.networth_unavailable") %></text>
      <text x="50%" y="<%= svgHeight / 2 + 10 %>" text-anchor="middle" font-size="12" fill="#ccc"><%= $t("dota2tracker.template.opendota.networth_unavailable_reason") %></text>
    <% } else { %>
      <text x="50%" y="30" text-anchor="middle" font-size="16" font-weight="bold"><%= $t("dota2tracker.template.networth") %></text>

      <%# 坐标轴与标签 %>
      <% for (let i = 0; i < 5; i++) { %>
        <% const y = padding + i * (chartH / 4); %>
        <line x1="<%= padding %>" y1="<%= y %>" x2="<%= svgWidth - padding %>" y2="<%= y %>" stroke="gray" stroke-width="1" />
        <text x="<%= padding - 2 %>" y="<%= y %>" text-anchor="end" dominant-baseline="middle" fill="#333a"><%= formatNum(nwLabels[i]) %></text>
      <% } %>

      <%# 时间轴 %>
      <% timeLabels.forEach(lbl => { %>
        <%# 始终绘制网格线 %>
        <line x1="<%= lbl.x %>" y1="<%= padding %>" x2="<%= lbl.x %>" y2="<%= svgHeight - padding %>" stroke="lightgray" stroke-width="1" />
        <%# 仅在不重叠时绘制文字 %>
        <% if (lbl.showText) { %>
        <text x="<%= lbl.x %>" y="<%= svgHeight - padding + 15 %>" text-anchor="middle" fill="#333a"><%= lbl.text %></text>
        <% } %>
      <% }); %>
      <line x1="<%= svgWidth - padding %>" y1="<%= padding %>" x2="<%= svgWidth - padding %>" y2="<%= svgHeight - padding %>" stroke="lightgray" stroke-width="1" />
      <text x="<%= svgWidth - padding %>" y="<%= svgHeight - padding + 15 %>" text-anchor="middle" fill="#333a"><%= `${Math.floor(duration / 60)}:${(duration % 60).toString().padStart(2, '0')}` %></text>

      <%# 玩家折线 %>
      <% pNwData.forEach((data, i) => { %>
        <% const color = pColors[match.players[i].playerSlot] || '#000'; %>
        <% const pts = data.map((v, idx) => `${getX(idx)},${svgHeight - padding - v * nwYScale}`).join(' '); %>
        <polyline points="<%= pts %>" fill="none" stroke="<%= color %>" stroke-width="2" />
      <% }); %>

      <%# 底部图例 (使用浅拷贝排序) %>
      <g transform="translate(<%= (svgWidth - (match.players.length * 30)) / 2 %>, <%= svgHeight - 27 %>)">
        <% [...match.players].sort((a, b) => a.networth - b.networth).forEach((p, i) => { %>
          <% const color = pColors[p.playerSlot] || '#000'; %>
          <rect x="<%= i * 30 %>" y="0" width="24" height="24" rx="6" ry="6" fill="#f0f0f0" stroke="<%= color %>" stroke-width="3" />
          <image x="<%= i * 30 %>" y="0" width="24" height="24" href="<%= getImageUrl(p.hero.shortName, ImageType.HeroIcons) %>" clip-path="inset(0 round 6)" />
        <% }); %>
      </g>
    <% } %>
  </svg>
</div>
