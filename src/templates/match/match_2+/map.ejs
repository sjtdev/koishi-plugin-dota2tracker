<% const match = data; %>
<%
const BUILDINGS = [
  // ================= 天辉 Radiant (左下) =================
  // 上路
  { id: 16, name: 'Rad Top T1',  type: 'tower', lane: "top", bit: 0, team: 'radiant', x: 35.8, y: 96.5 },
  { id: 19, name: 'Rad Top T2',  type: 'tower', lane: "top", bit: 1, team: 'radiant', x: 33.7, y: 133.8 },
  { id: 22, name: 'Rad Top T3',  type: 'tower', lane: "top", bit: 2, team: 'radiant', x: 32.5, y: 168.4 },
  { id: 38, name: 'Rad Top Melee', type: 'rax', lane: "top", bit: 0, team: 'radiant', x: 36.8, y: 174.5 },
  { id: 41, name: 'Rad Top Range', type: 'rax', lane: "top", bit: 1, team: 'radiant', x: 30, y: 174.5 },
  { id: 38, name: 'Rad Top HG Time', type: 'rax_time', lane: "top", bit: 0, team: 'radiant', x: 38.6, y: 180 },

  // 中路
  { id: 17, name: 'Rad Mid T1',  type: 'tower', lane: "mid", bit: 3, team: 'radiant', x: 101.2, y: 141 },
  { id: 20, name: 'Rad Mid T2',  type: 'tower', lane: "mid", bit: 4, team: 'radiant', x: 78.7, y: 161.8 },
  { id: 23, name: 'Rad Mid T3',  type: 'tower', lane: "mid", bit: 5, team: 'radiant', x: 59, y: 178.3 },
  { id: 39, name: 'Rad Mid Melee', type: 'rax', lane: "mid", bit: 2, team: 'radiant', x: 59.8, y: 185.1 },
  { id: 42, name: 'Rad Mid Range', type: 'rax', lane: "mid", bit: 3, team: 'radiant', x: 54.5, y: 180.5 },
  { id: 39, name: 'Rad Mid HG Time', type: 'rax_time', lane: "mid", bit: 2, team: 'radiant', x: 64, y: 187 },

  // 下路
  { id: 18, name: 'Rad Bot T1',  type: 'tower', lane: "bot", bit: 6, team: 'radiant', x: 189.3, y: 206.2 },
  { id: 21, name: 'Rad Bot T2',  type: 'tower', lane: "bot", bit: 7, team: 'radiant', x: 117.5, y: 207.2 },
  { id: 24, name: 'Rad Bot T3',  type: 'tower', lane: "bot", bit: 8, team: 'radiant', x: 68.7, y: 205 },
  { id: 40, name: 'Rad Bot Melee', type: 'rax', lane: "bot", bit: 4, team: 'radiant', x: 65, y: 210 },
  { id: 43, name: 'Rad Bot Range', type: 'rax', lane: "bot", bit: 5, team: 'radiant', x: 65, y: 202.7 },
  { id: 40, name: 'Rad Bot HG Time', type: 'rax_time', lane: "bot", bit: 4, team: 'radiant', x: 70, y: 211 },

  // 门牙 & 基地
  { id: 25, name: 'Rad T4 Left',  type: 'tower', lane: "mid", bit: 9, team: 'radiant', x: 44.7, y: 188.7 },
  { id: 25, name: 'Rad T4 Right', type: 'tower', lane: "mid", bit: 10, team: 'radiant', x: 50, y: 193.1 },
  { id: 25, name: 'Rad T4 Time',  type: 't4_time', lane: "mid", bit: [9,10], team: 'radiant', x: 53, y: 196 },
  { id: 50, name: 'Rad Ancient',  type: 'fort', lane: "", bit: -1, team: 'radiant', x: 39.5, y: 193.5 },
  { id: 50, name: 'Rad Ancient Time', type: 'fort_time', lane: "", bit: -1, team: 'radiant', x: 42, y: 207 },

  // ================= 夜魔 Dire (右上) =================
  // 上路
  { id: 26, name: 'Dire Top T1',  type: 'tower', lane: "top", bit: 0, team: 'dire', x: 50.4, y: 41 },
  { id: 29, name: 'Dire Top T2',  type: 'tower', lane: "top", bit: 1, team: 'dire', x: 120.7, y: 39.8 },
  { id: 32, name: 'Dire Top T3',  type: 'tower', lane: "top", bit: 2, team: 'dire', x: 170.7, y: 42.9 },
  { id: 44, name: 'Dire Top Melee', type: 'rax', lane: "top", bit: 0, team: 'dire', x: 176.5, y: 48.5 },
  { id: 47, name: 'Dire Top Range', type: 'rax', lane: "top", bit: 1, team: 'dire', x: 176.5, y: 40.8 },
  { id: 44, name: 'Dire Top HG Time', type: 'rax_time', lane: "top", bit: 0, team: 'dire', x: 181.5, y: 49 },

  // 中路
  { id: 27, name: 'Dire Mid T1',  type: 'tower', lane: "mid", bit: 3, team: 'dire', x: 129.4, y: 112.7 },
  { id: 30, name: 'Dire Mid T2',  type: 'tower', lane: "mid", bit: 4, team: 'dire', x: 156.4, y: 92.8 },
  { id: 33, name: 'Dire Mid T3',  type: 'tower', lane: "mid", bit: 5, team: 'dire', x: 180.6, y: 70.5 },
  { id: 45, name: 'Dire Mid Melee', type: 'rax', lane: "mid", bit: 2, team: 'dire', x: 187.5, y: 70.5 },
  { id: 48, name: 'Dire Mid Range', type: 'rax', lane: "mid", bit: 3, team: 'dire', x: 182.7, y: 65.6 },
  { id: 45, name: 'Dire Mid HG Time', type: 'rax_time', lane: "mid", bit: 2, team: 'dire', x: 187, y: 74 },

  // 下路
  { id: 28, name: 'Dire Bot T1',  type: 'tower', lane: "bot", bit: 6, team: 'dire', x: 207.8, y: 152.2 },
  { id: 31, name: 'Dire Bot T2',  type: 'tower', lane: "bot", bit: 7, team: 'dire', x: 209.75, y: 116.6 },
  { id: 34, name: 'Dire Bot T3',  type: 'tower', lane: "bot", bit: 8, team: 'dire', x: 208.7, y: 80.5 },
  { id: 46, name: 'Dire Bot Melee', type: 'rax', lane: "bot", bit: 4, team: 'dire', x: 213.2, y: 76.8 },
  { id: 49, name: 'Dire Bot Range', type: 'rax', lane: "bot", bit: 5, team: 'dire', x: 206.2, y: 76.8 },
  { id: 46, name: 'Dire Bot HG Time', type: 'rax_time', lane: "bot", bit: 4, team: 'dire', x: 214.5, y: 82 },

  // 门牙 & 基地
  { id: 35, name: 'Dire T4 Left',  type: 'tower', lane: "mid", bit: 9, team: 'dire', x: 189.7, y: 56.4 },
  { id: 35, name: 'Dire T4 Right', type: 'tower', lane: "mid", bit: 10, team: 'dire', x: 194.4, y: 60.2 },
  { id: 35, name: 'Dire T4 Time', type: 't4_time', lane: "mid", bit: [9, 10], team: 'dire', x: 198, y: 63 },
  { id: 51, name: 'Dire Ancient',  type: 'fort', lane: "", bit: -1, team: 'dire', x: 195.7, y: 49 },
  { id: 51, name: 'Dire Ancient Time',  type: 'fort_time', lane: "", bit: -1, team: 'dire', x: 210, y: 52 },
];
%>
<%
  // 1. 算法：提取摧毁时间 (Last Event Algorithm)
  const destructionTimes = {};
  if (match.playbackData && match.playbackData.buildingEvents) {
    match.playbackData.buildingEvents.forEach(evt => {
      if (evt.time > 0) {
        destructionTimes[evt.npcId] = evt.time;
      }
    });
  }

  // 2. 存活判定 (逻辑保持不变，确保正确引用 mask)
  const checkAlive = (b) => {
    let mask = 0;
    const isTowerType = b.type.includes('tower') || b.type === 't4_time';

    if (b.team === 'radiant') {
      mask = isTowerType ? match.towerStatusRadiant : match.barracksStatusRadiant;
    } else {
      mask = isTowerType ? match.towerStatusDire : match.barracksStatusDire;
    }

    // T4 时间锚点 (只要有一个活着，整体就算活)
    if (b.type === 't4_time') {
      const t1Alive = (mask & (1 << b.bit[0])) !== 0;
      const t2Alive = (mask & (1 << b.bit[1])) !== 0;
      return t1Alive || t2Alive;
    }

    // 基地 (胜负即生死)
    // 逻辑：如果是天辉建筑，天辉赢了=活；如果是夜魇建筑，天辉赢了=死(即 !match.didRadiantWin)
    if (b.type === 'fort_time' || b.type === 'fort') {
      return b.team === 'radiant' ? match.didRadiantWin : !match.didRadiantWin;
    }

    // 常规单位
    return (mask & (1 << b.bit)) !== 0;
  };

  // 3. 辅助：时间格式化
  const fmtTime = (s) => {
    const absS = Math.abs(s ?? 0);
    const m = Math.floor(absS / 60);
    const ss = (absS % 60).toString().padStart(2, '0');
    // 如果原数据确实是负数（极少数情况），手动加上符号
    return (s < 0 ? "-" : "") + `${m}:${ss}`;
  };

  // 4. 定义图标尺寸与权重
  const buildingProps = {
    rax: { size: 10, z: 1 },
    tower: { size: 12, z: 2 },
    fort: { size: 16, z: 3 },
    // 时间层级最高，确保覆盖在死掉的图标上
    rax_time: { size: 0, z: 10 },
    t4_time: { size: 0, z: 10 },
    fort_time: { size: 0, z: 10 },
    tower_time: { size: 0, z: 10 },
    _default: { size: 12, z: 0 }
  };

  const getProps = (type) => buildingProps[type] || buildingProps._default;
%>

<% const images = { minimapBase: "dotamap_7.40" } %>

<section class="map">
  <%- include("../../common/components/building_icons") %>
  <svg id="map" viewBox="0 0 255 255" width="250" height="250">
    <rect x="0" y="0" width="255" height="255" fill="#f5f5f5" rx="12" ry="12" />
    <image href="<%= getImageUrl(images.minimapBase) %>" width="255" height="255"/>
<%
  [...BUILDINGS].sort((a, b) => {
      return getProps(a.type).z - getProps(b.type).z;
  }).forEach(b => {
    const isAlive = checkAlive(b);
    const deathTime = destructionTimes[b.id];

    // 基础参数
    const props = getProps(b.type);
    const size = props.size;

    // 中心校准 (用于文字渲染)
    const centerX = b.x + (size / 2);
    const centerY = b.y + (size / 2);

    const rotation = b.lane === "mid" ? "_angle" : "";
    const iconRef = "#" + b.type + rotation;
    const statusClass = isAlive ? b.team : "dead";

    // ================= 极简白名单逻辑 =================

    // 1. 自渲染时间的塔：只有 T1 和 T2
    // 逻辑：类型是 tower, 且名字里不含 T3, 不含 T4
    const isOuterTower = b.type === 'tower' &&
                         !b.name.includes('T3') &&
                         !b.name.includes('T4');

    // 2. 虚拟时间锚点：数据表里留下的所有 _time 对象
    const isTimeAnchor = b.type.endsWith('_time');

    // 3. 最终开关
    const shouldRenderTime = (isOuterTower || isTimeAnchor) && !isAlive && deathTime;

%>

  <% /* 1. 图标渲染 (排除 _time 类型的纯虚拟点) */ %>
  <% if (!b.type.endsWith('_time')) { %>
    <use
      href="<%= iconRef %>"
      class="<%= statusClass %>"
      x="<%= b.x %>" y="<%= b.y %>"
      width="<%= size %>" height="<%= size %>"
    />
  <% } %>

  <% /* 2. 时间文字渲染 (无旋转，自然居中) */ %>
  <% if (shouldRenderTime) { %>
     <text
       x="<%= centerX %>"
       y="<%= centerY %>"
       fill="#ccc"
       font-weight="bold"
       text-anchor="middle"
       dominant-baseline="middle"
     >
       <%= fmtTime(deathTime) %>
     </text>
  <% } %>

<% }) %>
  </svg>
</section>
