<%# --- 核心逻辑 --- %>
<% const match = data; %>

<%# --- 等级进度圈计算 --- %>
<% const getLevelInfo = (xp) => {
     const XP = dotaconstants.xp_level;
     let lvl = XP.findIndex(l => xp < l) - 1;
     if (lvl < 0) lvl = XP.length - 1;
     const curr = xp - XP[lvl];
     const next = XP[lvl + 1] - XP[lvl];
     const pct = curr / next;
     const r = 12, size = 32, center = 16;
     const circum = 2 * Math.PI * r;
     const prog = circum * pct;
     const gap = circum - prog;
     return { lvl, prog, gap, r, size, center };
   };
%>

<%# --- 单组对抗数据生成器 --- %>
<% const getLaneData = (posRadiant, posDire) => {
     // 筛选逻辑：根据位置和阵营精确匹配
     // posRadiant/posDire 是数字数组，如 [3] 或 [3, 4]
     const rivals = match.players.filter(p => {
       const pos = parseInt(p.position.slice(-1)); // 提取位置数字
       const isRad = p.isRadiant;
       return (isRad && posRadiant.includes(pos)) || (!isRad && posDire.includes(pos));
     }).sort((a, b) => b.isRadiant - a.isRadiant); // 排序确保：天辉(1)在前，夜魇(0)在后

     // 如果凑不齐两个人（比如有人掉线没数据，或者本来就是1v0），则不渲染这一组
     if (rivals.length < 2) return null;

     const p1 = rivals[0], p2 = rivals[1];
     const getStat = (p, type) => {
       if (match.odParsed) return "-";
       return p.stats[type + "Events"]?.filter(e => e.time <= 600).length || 0;
     };

     // 经济计算 (10分钟快照)
     const getGold10 = p => p.stats.networthPerMinute.at(Math.min(10, p.stats.networthPerMinute.length - 1));
     const g1 = getGold10(p1), g2 = getGold10(p2);
     const totalG = g1 + g2, split = g1 / (totalG || 1);
     const diff = Math.abs(g2 - g1);
     const diffColor = g1 > g2 ? "#3c9028" : "#9c3628";

     // 经验计算
     const getXp10 = p => p.stats.experiencePerMinute.slice(0, Math.min(11, p.stats.experiencePerMinute.length - 1)).reduce((a, b) => a + b, 0);

     return {
       p1: { ...p1, k: getStat(p1, 'kill'), d: getStat(p1, 'death'), a: getStat(p1, 'assist'), lvl: getLevelInfo(getXp10(p1)) },
       p2: { ...p2, k: getStat(p2, 'kill'), d: getStat(p2, 'death'), a: getStat(p2, 'assist'), lvl: getLevelInfo(getXp10(p2)) },
       gold: { g1, g2, split, diff, diffColor, isOd: match.odParsed }
     };
   };
%>

<div class="lane_outcome">
  <h4 class="title"><%= $t("dota2tracker.template.lane") %></h4>
  <% if (match.odParsed) { %>
  <p class="subtitle"><%= $t("dota2tracker.template.opendota.lane_outcome_tip") %></p>
  <% } %>

  <div class="panel">

    <%# --- 重新定义分路配置 --- %>
    <%# 结构: [Key, Outcome字段, [ [第一组天辉pos, 第一组夜魇pos], [第二组天辉pos, 第二组夜魇pos]... ]] %>
    <% const lanes = [
         // 上路: (天辉3 vs 夜魇1) 和 (天辉4 vs 夜魇5)
         ["lane_top", match.topLaneOutcome, [ [[3], [1]], [[4], [5]] ]],
         // 中路: (天辉2 vs 夜魇2)
         ["lane_mid", match.midLaneOutcome, [ [[2], [2]] ]],
         // 下路: (天辉1 vs 夜魇3) 和 (天辉5 vs 夜魇4)
         ["lane_bottom", match.bottomLaneOutcome, [ [[1], [3]], [[5], [4]] ]]
       ];
    %>

    <% lanes.forEach(([labelKey, outcome, pairs]) => { %>
    <div class="lane">
      <div class="title">
        <p><%= $t("dota2tracker.template." + labelKey) %></p>
        <p class="<%= outcome.split("_")[0].toLowerCase() %>"><%= $t("dota2tracker.template.OUTCOME_MAP." + outcome) %></p>
      </div>

      <%# --- 遍历这一路的每一组对抗 (pairs) --- %>
      <% pairs.forEach(([radPos, direPos]) => { %>
        <% const laneData = getLaneData(radPos, direPos); %>

        <% if (laneData) { %>
        <div class="details">
          <%# 天辉部分 %>
          <img src="<%= getImageUrl(laneData.p1.hero.shortName, ImageType.HeroIcons) %>" class="hero radiant" />

          <svg width="32" height="32" viewBox="0 0 32 32">
            <circle cx="16" cy="16" r="12" fill="none" stroke="#eee" stroke-width="2"/>
            <circle cx="16" cy="16" r="12" fill="none" stroke="#ffd700" stroke-width="2"
                    stroke-dasharray="<%= laneData.p1.lvl.prog %> <%= laneData.p1.lvl.gap %>"
                    stroke-linecap="round" transform="rotate(-90 16 16)"/>
            <text x="16" y="16" text-anchor="middle" dominant-baseline="middle" fill="#333" font-size="10" font-weight="bold"><%= laneData.p1.lvl.lvl %></text>
          </svg>

          <p class="kda"><%= laneData.p1.k %>/<%= laneData.p1.d %>/<%= laneData.p1.a %></p>

          <%# 经济对比条 %>
          <div class="graph">
            <svg width="100%" height="32" viewBox="0 0 180 32">
              <g transform="translate(0,0)">
                <rect y="9" width="180" height="14" fill="#9c3628"/>
                <rect y="9" width="<%= 180 * laneData.gold.split %>" height="14" fill="#3c9028"/>
                <line x1="<%= 180 * laneData.gold.split %>" y1="9" x2="<%= 180 * laneData.gold.split %>" y2="25" stroke="#fff" stroke-width="1"/>

                <text x="5" y="50%" dominant-baseline="middle" fill="#fff" font-size="10" text-anchor="start">
                  <%= laneData.gold.isOd ? "~" : "" %><%= laneData.gold.g1 %>
                </text>
                <text x="175" y="50%" dominant-baseline="middle" fill="#fff" font-size="10" text-anchor="end">
                  <%= laneData.gold.isOd ? "~" : "" %><%= laneData.gold.g2 %>
                </text>
                <text x="<%= 180 * laneData.gold.split %>" y="5px" dominant-baseline="middle" fill="<%= laneData.gold.diffColor %>" font-size="10" text-anchor="middle">
                  +<%= laneData.gold.diff %>
                </text>
              </g>
            </svg>
          </div>

          <p class="kda"><%= laneData.p2.k %>/<%= laneData.p2.d %>/<%= laneData.p2.a %></p>

          <%# 夜魇部分 %>
          <svg width="32" height="32" viewBox="0 0 32 32">
            <circle cx="16" cy="16" r="12" fill="none" stroke="#eee" stroke-width="2"/>
            <circle cx="16" cy="16" r="12" fill="none" stroke="#ffd700" stroke-width="2"
                    stroke-dasharray="<%= laneData.p2.lvl.prog %> <%= laneData.p2.lvl.gap %>"
                    stroke-linecap="round" transform="rotate(-90 16 16)"/>
            <text x="16" y="16" text-anchor="middle" dominant-baseline="middle" fill="#333" font-size="10" font-weight="bold"><%= laneData.p2.lvl.lvl %></text>
          </svg>

          <img src="<%= getImageUrl(laneData.p2.hero.shortName, ImageType.HeroIcons) %>" class="hero dire" />
        </div>
        <% } %>
      <% }); %>

    </div>
    <% }); %>

  </div>
</div>
